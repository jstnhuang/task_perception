<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="shared-styles.html">

<dom-module id="pbi-annotator">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      iron-image {
        background-color: var(--paper-grey-300);
        width: 100%;
      }
      .open {
        background-color: var(--paper-green-500);
        color: #fff;
      }
      ros-rviz {
        display: block;
        width: 100%;
      }
      .main {
        height: 100%;
      }
    </style>
    <ros-topic auto
      last-message="{{state}}"
      msg-type="task_perception_msgs/AnnotatorState"
      topic="pbi_annotator/state"
      ros="[[ros]]"></ros-topic>
    <ros-topic
      id="eventPub"
      msg-type="task_perception_msgs/AnnotatorEvent"
      topic="pbi_annotator/events"
      ros="[[ros]]"></ros-topic>
    <div class="main layout vertical">
      <div class="layout horizontal center">
        <paper-input class="flex" id="bagPathInput" label="Bag file to annotate" value="[[state.bag_path]]"></paper-input>
        <paper-button class="open" on-tap="openFile">Open</paper-button>
      </div>
      <!--ros-rviz id="rviz" class="flex" ros="[[ros]]"></ros-rviz-->
      <div class="layout horizontal">
        <paper-slider min="0" max="[[state.frame_count]]" step="1" value="[[state.current_frame]]"
          pin class="flex" id="scrubber" disabled></paper-slider>
        <paper-button on-tap="_handleNext">Next</paper-button>
      </div>
    </div>
  </template>
  <script>
    class PbiAnnotator extends Polymer.Element {
      static get is() { return 'pbi-annotator'; }
      static get properties() {
        return {
          ros: Object,
        };
      }

      connectedCallback() {
        super.connectedCallback();

        var config = {
          "globalOptions": {
            "background": "#113344",
            "colladaLoader": "collada2",
            "colladaServer": "http://localhost:8001/",
            "fixedFrame": "/base_link",
            "url": "ws://localhost:9090",
            "videoServer": "http://localhost:8888"
          },
          "sidebarOpened": false,
          "displays": [
            {
              "isShown": true,
              "name": "Grid",
              "options": {
                "cellSize": "1",
                "color": "#cccccc",
                "numCells": "10"
              },
              "type": "grid"
            },
            {
              "isShown": true,
              "name": "Depth cloud",
              "options": {
                "topic": "depthcloud_encoded",
                "frameId": "/head_mount_kinect_rgb_optical_frame"
              },
              "type": "depthCloud"
            },
            {
              "isShown": true,
              "name": "Skeleton",
              "options": {
                "topic": "/skeleton"
              },
              "type": "markerArray"
            }
          ]
        };

        this.$.rviz.config = config;
      }

      openFile() {
        if (!this.$.bagPathInput.value) {
          console.error('No bag file specified.');
          return;
        }
        var msg = {
          type: 'open bag',
          bag_path: this.$.bagPathInput.value
        };
        this.$.eventPub.publish(msg);
      }

      _handleNext(evt) {
        var msg = {
          type: 'step',
        };
        this.$.eventPub.publish(msg);
      }
    };
    window.customElements.define(PbiAnnotator.is, PbiAnnotator);
  </script>
</dom-module>
