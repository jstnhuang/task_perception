<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="shared-styles.html">

<dom-module id="pbi-annotator">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      iron-image {
        background-color: var(--paper-grey-300);
        width: 100%;
      }
      .open {
        background-color: var(--paper-green-500);
        color: #fff;
      }
      ros-rviz {
        display: block;
        width: 100%;
      }
      .main {
        height: 100%;
      }
    </style>
    <ros-topic auto
      last-message="{{state}}"
      msg-type="task_perception_msgs/AnnotatorState"
      topic="pbi_annotator/state"
      ros="[[ros]]"></ros-topic>
    <ros-topic
      id="eventPub"
      msg-type="task_perception_msgs/AnnotatorEvent"
      topic="pbi_annotator/events"
      ros="[[ros]]"></ros-topic>
    <div class="main layout vertical">
      <div class="layout horizontal center">
        <paper-input class="flex" label="Bag file to annotate" value="{{state.bag_path}}"></paper-input>
        <paper-button class="open" on-tap="openFile">Open</paper-button>
        <div class="flex"></div>
        <a href="/recorder">Record a new video</a>
      </div>
      <ros-rviz id="rviz" class="flex" global-options="{{globalOptions}}" ros="[[ros]]"></ros-rviz>
      <div class="layout horizontal">
        <paper-slider min="0" max="[[_bagLength]]" step="0.01" immediate-value="{{time}}"
          pin editable class="flex" id="scrubber"></paper-slider>
      </div>
    </div>
  </template>
  <script>
    class PbiAnnotator extends Polymer.Element {
      static get is() { return 'pbi-annotator'; }
      static get properties() {
        return {
          globalOptions: {
            type: Object,
            value: function() {
              return {
                fixedFrame: '/base_link',
                background: '#113344',
              };
            }
          },
          ros: Object,
          state: {
            type: Object,
            value: function() {
              return {
                bag_path: '',
              }
            }
          },
          time: {
            type: Number,
            value: 0,
            observer: '_timeChanged'
          },
          _bagLength: {
            type: Number,
            computed: '_computeBagLength(state)'
          },
          _videoUrl: {
            type: String,
            value: 'http://' + window.location.hostname + ':8888/stream?topic=/pbi_annotator/image_color'
          },
        };
      }

      connectedCallback() {
        super.connectedCallback();
        //this.$.image.height = this.$.image.offsetWidth * 0.75;

        var config = {
          globalOptions: {
            fixedFrame: '/base_link',
            background: '#113344',
          },
          displays: [
            {
              isShown: true,
              name: 'Grid',
              type: 'grid',
              options: {
                cellSize: 1,
                color: '#cccccc',
                numCells: 20,
              },
            }, {
              isShown: false,
              name: 'Objects',
              type: 'markers',
              options: {
                topic: '/pbi_annotator/object_tracking_viz',
              },
            },
          ],
          sidebarOpened: false,
        };

        this.$.rviz.loadConfig(config);
        this._depthCloud = new ROS3D.DepthCloud({
          url: 'http://' + window.location.hostname + ':8888/streams/depthcloud_encoded.webm?enc=webm&bitrate=250000&framerate=15',
          f: 525.0,
          pointSize: 1,
        });
        this._depthCloud.startStream();
        this._kinectNode = new ROS3D.SceneNode({
          frameID: '/pbi_annotator/camera_frame',
          tfClient: this.$.rviz.tfClient,
          object: this._depthCloud
        });

        var that = this;
        setTimeout(function() {
        console.log(this.$.rviz, this.$.rviz._viewer);
          this.$.rviz._viewer.scene.add(this._kinectNode);
        }.bind(this), 0);
      }

      openFile() {
        if (!this.state || !this.state.bag_path) {
          console.error('No bag file specified.');
          return;
        }
        var msg = {
          type: 'open bag',
          bag_path: this.state.bag_path
        };
        this.$.eventPub.publish(msg);
        var msg = {
          type: 'view time',
          time: {
            secs: 0,
            nsecs: 0
          }
        };
        this.$.eventPub.publish(msg);
      }

      // Return the bag length, in seconds.
      _computeBagLength(state) {
        if (!state || !state.bag_length) {
          return 0;
        }
        this.$.scrubber.value = 0;
        return state.bag_length.secs + state.bag_length.nsecs / 1000000000.0;
      }

      _timeChanged(time) {
        if (!time || isNaN(time)) {
          return
        }
        var secs = Math.floor(time);
        var nsecs = Math.round((time - secs) * 1000000000);
        var msg = {
          type: 'view time',
          time: {
            secs: secs,
            nsecs: nsecs
          }
        };
        this.$.eventPub.publish(msg);
      }
    };
    window.customElements.define(PbiAnnotator.is, PbiAnnotator);
  </script>
</dom-module>
