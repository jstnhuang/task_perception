<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="shared-styles.html">

<dom-module id="pbi-annotator">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
      img {
        background-color: var(--paper-grey-300);
        width: 100%;
      }
      .open {
        background-color: var(--paper-green-500);
        color: #fff;
      }
    </style>
    <ros-topic auto
      last-message="{{state}}"
      msg-type="task_perception_msgs/AnnotatorState"
      topic="pbi_annotator/state"
      ros="[[ros]]"></ros-topic>
    <ros-topic
      id="eventPub"
      msg-type="task_perception_msgs/AnnotatorEvent"
      topic="pbi_annotator/events"
      ros="[[ros]]"></ros-topic>
    <div class="layout horizontal center">
      <paper-input class="flex" label="Bag file to annotate" value="{{bagPath}}"></paper-input>
      <paper-button class="open" on-tap="openFile">Open</paper-button>
      <div class="flex"></div>
      <a href="/recorder">Record a new video</a>
    </div>
    <div>
      <img src$="[[_videoUrl]]"></img>
    </div>
    <div class="layout horizontal">
      <paper-slider min="0" max="[[_bagLength]]" step="0.01" immediate-value="{{time}}"
        pin editable class="flex"></paper-slider>
    </div>
  </template>
  <script>
    class PbiAnnotator extends Polymer.Element {
      static get is() { return 'pbi-annotator'; }
      static get properties() {
        return {
          bagPath: {
            type: String,
            value: '/tmp/task.bag'
          },
          ros: Object,
          state: Object,
          time: {
            type: Number,
            value: 0,
            observer: '_timeChanged'
          },
          _bagLength: {
            type: Number,
            computed: '_computeBagLength(state)'
          },
          _videoUrl: {
            type: String,
            value: 'http://' + window.location.hostname + ':8888/stream?topic=/pbi_annotator/image_color'
          },
        };
      }

      openFile() {
        var msg = {
          type: 'open bag',
          bag_path: this.bagPath
        };
        this.$.eventPub.publish(msg);
        var msg = {
          type: 'view time',
          time: {
            secs: 0,
            nsecs: 0
          }
        };
        this.$.eventPub.publish(msg);
      }

      // Return the bag length, in seconds.
      _computeBagLength(state) {
        if (!state || !state.bag_length) {
          return 0;
        }
        return state.bag_length.secs + state.bag_length.nsecs / 1000000000.0;
      }

      _timeChanged(time) {
        var secs = Math.floor(time);
        var nsecs = Math.round((time - secs) * 1000000000);
        var msg = {
          type: 'view time',
          time: {
            secs: secs,
            nsecs: nsecs
          }
        };
        this.$.eventPub.publish(msg);
      }
    };
    window.customElements.define(PbiAnnotator.is, PbiAnnotator);
  </script>
</dom-module>
